# Excel表格合并工具 - 打包说明 📦

本文档说明如何将GUI程序打包成Windows可执行文件（.exe）。

## 为什么要打包成EXE？

打包后的EXE文件有以下优势：

✅ **无需Python环境** - 用户无需安装Python即可使用  
✅ **一键运行** - 双击即可启动，更加便捷  
✅ **易于分发** - 可以直接分享给其他用户  
✅ **独立运行** - 包含所有依赖，不会出现环境问题  

## 打包前准备

### 1. 确保Python环境正常

```bash
python --version
# 应该显示 Python 3.6 或更高版本
```

### 2. 安装必要的依赖

```bash
pip install -r requirements.txt
pip install pyinstaller
```

或者让打包脚本自动安装（推荐）。

## 开始打包

### 方法一：使用批处理文件（最简单）

**Windows用户：**

1. 双击运行 `打包成EXE.bat`
2. 按提示操作
3. 等待打包完成

### 方法二：使用Shell脚本

**Linux/Mac用户：**

```bash
./打包成EXE.sh
```

### 方法三：直接运行Python脚本

```bash
python build_exe.py
```

## 打包过程

打包脚本会自动完成以下步骤：

1. ✓ 检查Python环境
2. ✓ 检查并安装PyInstaller（如果需要）
3. ✓ 创建PyInstaller配置文件（.spec）
4. ✓ 开始打包程序
5. ✓ 生成可执行文件
6. ✓ 创建使用说明
7. ✓ 清理临时文件

## 打包配置说明

### 配置文件：excel_merger_gui.spec

打包脚本会自动生成配置文件，主要配置项：

```python
# 程序名称
name='Excel表格合并工具'

# 打包模式
onefile=True  # 单文件模式，所有依赖打包到一个exe中

# 控制台窗口
console=False  # 不显示黑色控制台窗口

# UPX压缩
upx=True  # 启用压缩，减小文件体积

# 隐藏导入
hiddenimports=['openpyxl', 'pandas', 'tkinter']
```

### 自定义配置

如果需要自定义配置，可以编辑生成的 `excel_merger_gui.spec` 文件，然后运行：

```bash
pyinstaller excel_merger_gui.spec --clean
```

## 打包结果

### 输出目录结构

```
workspace/
├── dist/                          # 打包输出目录
│   ├── Excel表格合并工具.exe     # 可执行文件 ⭐
│   └── 使用说明.txt               # 使用说明
├── build/                         # 临时构建目录（会自动清理）
└── excel_merger_gui.spec          # PyInstaller配置文件
```

### 文件说明

- **Excel表格合并工具.exe** - 主程序，约50-100MB
- **使用说明.txt** - 简要使用说明

## 测试打包的EXE

### 1. 找到EXE文件

```
dist/Excel表格合并工具.exe
```

### 2. 双击运行

直接双击运行，如果能正常启动GUI界面，说明打包成功。

### 3. 功能测试

- 选择测试用的Excel文件（example1.xlsx等）
- 尝试合并操作
- 检查是否能正常生成输出文件

## 分发给其他用户

### 方法一：分发整个dist目录（推荐）

1. 将整个 `dist` 目录打包成zip
2. 分享给其他用户
3. 用户解压后双击运行exe即可

### 方法二：仅分发exe文件

1. 只分享 `Excel表格合并工具.exe`
2. 文件较大，传输时间较长
3. 第一次运行可能需要解压临时文件（稍慢）

## 常见问题 ❓

### Q1: 打包后的文件太大？

**原因：** PyInstaller会打包所有依赖库。

**解决方法：**
- 启用UPX压缩（默认已启用）
- 排除不必要的模块
- 使用虚拟环境打包（减少额外依赖）

### Q2: 打包失败，提示找不到模块？

**解决方法：**
- 确保所有依赖都已安装：`pip install -r requirements.txt`
- 在 `.spec` 文件的 `hiddenimports` 中添加缺失的模块
- 重新运行打包

### Q3: 杀毒软件报警？

**原因：** PyInstaller打包的exe可能被杀毒软件误报。

**解决方法：**
- 添加到白名单
- 使用数字签名（需要证书）
- 告知用户这是误报

### Q4: 在其他电脑上无法运行？

**检查项：**
- 目标系统是否是Windows
- 是否是64位系统（默认打包为64位）
- 是否被杀毒软件阻止
- 尝试以管理员身份运行

### Q5: 第一次运行很慢？

**原因：** 单文件模式的exe第一次运行时需要解压临时文件。

**说明：**
- 第一次运行：10-30秒
- 后续运行：正常速度
- 这是正常现象

## 高级配置

### 添加程序图标

1. 准备一个 `.ico` 图标文件
2. 在 `.spec` 文件中设置：
   ```python
   icon='path/to/icon.ico'
   ```
3. 重新打包

### 打包成文件夹模式

如果希望打包成文件夹（启动快，文件多）：

1. 修改 `build_exe.py` 中的打包命令
2. 改为：
   ```python
   subprocess.check_call([
       "pyinstaller",
       "--onedir",  # 改为文件夹模式
       "excel_merger_gui.py"
   ])
   ```

### 添加版本信息

创建 `version.txt`：

```
VSVersionInfo(
  ffi=FixedFileInfo(
    filevers=(1, 0, 0, 0),
    prodvers=(1, 0, 0, 0),
    ...
  )
)
```

在打包时使用 `--version-file` 参数。

## 优化建议

### 1. 使用虚拟环境打包

```bash
# 创建虚拟环境
python -m venv venv_build

# 激活虚拟环境
venv_build\Scripts\activate  # Windows
source venv_build/bin/activate  # Linux/Mac

# 安装必要依赖
pip install pandas openpyxl pyinstaller

# 打包
python build_exe.py
```

这样可以减小最终exe的体积。

### 2. 启用更多压缩选项

编辑 `.spec` 文件，添加：

```python
exe = EXE(
    ...
    upx=True,
    upx_exclude=['vcruntime140.dll'],  # 排除某些dll
    ...
)
```

### 3. 排除不必要的模块

```python
a = Analysis(
    ...
    excludes=['matplotlib', 'scipy', 'numpy'],  # 如果不需要这些模块
    ...
)
```

## 技术细节

### PyInstaller工作原理

1. **分析依赖** - 扫描Python脚本，找出所有依赖
2. **收集文件** - 收集Python解释器、依赖库等
3. **生成引导程序** - 创建启动加载器
4. **打包压缩** - 将所有文件打包到exe中
5. **运行时解压** - exe运行时先解压到临时目录

### 单文件 vs 文件夹模式

| 特性 | 单文件模式 | 文件夹模式 |
|------|-----------|-----------|
| 文件数量 | 1个exe | 1个exe + 多个dll/pyd |
| 启动速度 | 较慢（首次） | 快 |
| 分发便利性 | 高 | 中 |
| 文件大小 | 较大 | 较小 |
| 推荐度 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |

## 故障排除

### 打包日志

如果打包失败，查看详细日志：

```bash
pyinstaller excel_merger_gui.spec --log-level DEBUG
```

### 常见错误

**错误1：ModuleNotFoundError**
```
解决：在hiddenimports中添加缺失模块
```

**错误2：UPX压缩失败**
```
解决：在.spec文件中设置 upx=False
```

**错误3：tkinter导入失败**
```
解决：确保系统安装了tkinter
Windows: 默认已安装
Linux: sudo apt-get install python3-tk
```

## 最佳实践

1. ✅ 在干净的虚拟环境中打包
2. ✅ 打包前先测试源代码
3. ✅ 在目标系统上测试打包结果
4. ✅ 保留.spec文件以便后续修改
5. ✅ 定期更新PyInstaller版本
6. ✅ 为exe添加版本信息和图标
7. ✅ 准备详细的使用说明

## 相关资源

- PyInstaller官方文档：https://pyinstaller.org/
- PyInstaller GitHub：https://github.com/pyinstaller/pyinstaller
- Python打包指南：https://packaging.python.org/

---

如有问题，请参考本文档或查看PyInstaller官方文档。祝打包顺利！🎉
